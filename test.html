<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#000814">
  <title>LieutenantHead - Makine ƒ∞ncelemesi</title>

  <!-- Three.js -->
  <script src="https://unpkg.com/three@0.139.2/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.139.2/examples/js/controls/OrbitControls.js"></script>
  <script src="https://unpkg.com/three@0.139.2/examples/js/loaders/GLTFLoader.js"></script>

  <!-- GSAP -->
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>

  <style>
    * { -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }
    html, body { width: 100%; height: 100%; }
    body { 
      margin: 0; 
      overflow: hidden; 
      background: #000; 
      font-family: 'Segoe UI', sans-serif;
      position: fixed;
      touch-action: none;
    }
    canvas { display: block; width: 100%; height: 100%; }
    
    .info {
      position: fixed; top: max(15px, env(safe-area-inset-top)); left: max(15px, env(safe-area-inset-left)); 
      color: #0ff; font-family: 'Courier New', monospace;
      background: rgba(0,0,0,0.8); padding: 10px 15px; border-radius: 8px; font-size: clamp(12px, 2vw, 14px);
      border: 1px solid #0ff; text-shadow: 0 0 8px #0ff; z-index: 100; pointer-events: none;
      max-width: 90vw; word-wrap: break-word;
    }
    
    .controls {
      position: fixed; bottom: max(20px, env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.85); padding: 12px 20px; border-radius: 50px;
      color: #0ff; font-family: monospace; font-size: clamp(12px, 2.5vw, 16px); 
      border: 1px solid #0ff;
      box-shadow: 0 0 20px rgba(0,255,255,0.4); z-index: 100; text-align: center;
      display: flex; gap: 8px; align-items: center; justify-content: center;
      flex-wrap: wrap; max-width: 95vw;
    }
    
    .controls button {
      background: #0a3d62; color: #0ff; border: 1px solid #0ff; padding: clamp(8px, 1.5vw, 12px) clamp(12px, 2vw, 20px);
      border-radius: 25px; cursor: pointer; font-weight: bold; font-size: clamp(11px, 2vw, 14px);
      transition: all 0.3s; box-shadow: 0 0 10px rgba(0,255,255,0.3);
      -webkit-tap-highlight-color: transparent;
      active: 0 0 20px rgba(0,255,255,0.8);
    }
    
    .controls button:active { 
      background: #0ff; 
      color: #000; 
      box-shadow: 0 0 20px rgba(0,255,255,0.8);
      transform: scale(0.95);
    }
    
    .controls button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .mobile-controls {
      position: fixed; right: max(15px, env(safe-area-inset-right)); top: max(70px, calc(env(safe-area-inset-top) + 70px));
      background: rgba(0,0,0,0.85); padding: 15px; border-radius: 12px;
      border: 1px solid #0ff; z-index: 99; max-height: 80vh; overflow-y: auto;
      transform: translateX(400px); transition: transform 0.3s ease;
    }

    .mobile-controls.open { transform: translateX(0); }

    .mobile-controls h3 {
      color: #0ff; margin: 0 0 12px 0; font-size: 14px;
      border-bottom: 1px solid #0ff; padding-bottom: 8px;
    }

    .control-item {
      margin: 12px 0; display: flex; flex-direction: column; gap: 6px;
    }

    .control-item label {
      color: #0ff; font-size: 12px; font-family: monospace;
    }

    .control-item input[type="range"] {
      width: 150px; cursor: pointer;
    }

    .settings-btn {
      position: fixed; right: max(15px, env(safe-area-inset-right)); top: max(15px, env(safe-area-inset-top));
      background: #0a3d62; color: #0ff; border: 1px solid #0ff; 
      width: 45px; height: 45px; border-radius: 50%;
      cursor: pointer; font-size: 20px; z-index: 101;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 10px rgba(0,255,255,0.3);
      transition: all 0.3s;
      -webkit-tap-highlight-color: transparent;
    }

    .settings-btn:active { background: #0ff; color: #000; }

    .loading {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      color: #0ff; font-size: clamp(16px, 4vw, 20px); text-shadow: 0 0 15px #0ff;
      z-index: 102;
    }

    .device-info {
      font-size: 11px; margin-top: 8px; padding-top: 8px;
      border-top: 1px solid #0ff; color: #0aa;
    }

    @media (max-width: 768px) {
      .controls { gap: 6px; padding: 10px 15px; }
      .controls button { padding: 10px 15px; }
      .mobile-controls { right: max(10px, env(safe-area-inset-right)); top: max(65px, calc(env(safe-area-inset-top) + 65px)); }
    }

    @media (max-width: 480px) {
      .controls button { font-size: 12px; padding: 8px 12px; }
      .info { font-size: 11px; padding: 8px 12px; }
      .settings-btn { width: 40px; height: 40px; font-size: 18px; }
    }
  </style>
</head>
<body>

  <div class="info">
    <span id="device">üì± Mobil</span> | <span id="instructions">Dokunup s√ºr√ºkle: D√∂nd√ºr ‚Ä¢ ƒ∞ki parmak: Yakƒ±nla≈ü</span><br>
    <span id="status">Hazƒ±r</span>
  </div>

  <button class="settings-btn" id="settingsBtn">‚öôÔ∏è</button>

  <div class="mobile-controls" id="mobileControls">
    <h3>Ayarlar</h3>
    <div class="control-item">
      <label>D√∂nd√ºrme Hƒ±zƒ±: <span id="rotationSpeedValue">1.0</span>x</label>
      <input type="range" id="rotationSpeed" min="0.1" max="2" step="0.1" value="1" />
    </div>
    <div class="control-item">
      <label>Yakƒ±nla≈ütƒ±rma Hƒ±zƒ±: <span id="zoomSpeedValue">1.0</span>x</label>
      <input type="range" id="zoomSpeed" min="0.1" max="2" step="0.1" value="1" />
    </div>
    <div class="device-info" id="deviceInfo"></div>
  </div>

  <div class="controls">
    <button id="explodeBtn">PAR√áALA</button>
    <button id="collectBtn">TOPLA</button>
    <button id="autoBtn">OTOMATƒ∞K TUR</button>
  </div>

  <div class="loading" id="loading">Model Y√ºkleniyor...</div>

  <canvas id="canvas"></canvas>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const canvas = document.getElementById('canvas');
      const loadingEl = document.getElementById('loading');
      const statusEl = document.getElementById('status');
      const explodeBtn = document.getElementById('explodeBtn');
      const collectBtn = document.getElementById('collectBtn');
      const autoBtn = document.getElementById('autoBtn');
      const settingsBtn = document.getElementById('settingsBtn');
      const mobileControls = document.getElementById('mobileControls');
      const deviceEl = document.getElementById('device');
      const instructionsEl = document.getElementById('instructions');
      const deviceInfoEl = document.getElementById('deviceInfo');
      const rotationSpeedSlider = document.getElementById('rotationSpeed');
      const zoomSpeedSlider = document.getElementById('zoomSpeed');
      const rotationSpeedValue = document.getElementById('rotationSpeedValue');
      const zoomSpeedValue = document.getElementById('zoomSpeedValue');

      // === Cƒ∞HAZ TESPƒ∞Tƒ∞ ===
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const isTablet = /iPad|Android/.test(navigator.userAgent);
      
      if (isMobile) {
        deviceEl.textContent = isTablet ? 'üì± Tablet' : 'üì± Mobil';
        instructionsEl.textContent = 'Dokunup s√ºr√ºkle: D√∂nd√ºr ‚Ä¢ ƒ∞ki parmak: Yakƒ±nla≈ü/Uzak';
      }

      deviceInfoEl.innerHTML = `
        <strong>Cihaz:</strong> ${navigator.userAgent.substring(0, 50)}...<br>
        <strong>Ekran:</strong> ${window.innerWidth}x${window.innerHeight}px<br>
        <strong>DPR:</strong> ${window.devicePixelRatio.toFixed(2)}<br>
        <strong>Touch:</strong> ${('ontouchstart' in window) ? 'Destekleniyor ‚úì' : 'Yok ‚úó'}
      `;

      // === AYARLAR PANELI ===
      settingsBtn.addEventListener('click', () => {
        mobileControls.classList.toggle('open');
      });

      canvas.addEventListener('touchstart', () => {
        if (mobileControls.classList.contains('open')) {
          mobileControls.classList.remove('open');
        }
      });

      rotationSpeedSlider.addEventListener('input', (e) => {
        rotationSpeedValue.textContent = parseFloat(e.target.value).toFixed(1);
        controls.autoRotateSpeed = 0.5 * parseFloat(e.target.value);
      });

      zoomSpeedSlider.addEventListener('input', (e) => {
        zoomSpeedValue.textContent = parseFloat(e.target.value).toFixed(1);
      });

      // Sahne
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x000814);

      // Kamera
      const camera = new THREE.PerspectiveCamera(60, innerWidth / innerHeight, 0.1, 1000);
      camera.position.set(0, 0, 10);

      // Renderer
      const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
      renderer.setSize(innerWidth, innerHeight);
      renderer.setPixelRatio(Math.min(devicePixelRatio, 2));

      // Kontroller
      const controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.target.set(0, 0, 0);
      controls.enableZoom = true;

      // === DOKUNMATIK KONTROLLER ===
      let touchStartDistance = 0;
      let lastZoom = camera.position.length();

      canvas.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          touchStartDistance = Math.sqrt(dx * dx + dy * dy);
          lastZoom = camera.position.length();
        }
      });

      canvas.addEventListener('touchmove', (e) => {
        if (e.touches.length === 2) {
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          const currentDistance = Math.sqrt(dx * dx + dy * dy);
          const scale = touchStartDistance / currentDistance;
          const zoomSpeed = parseFloat(zoomSpeedSlider.value);
          const newZoom = lastZoom * scale * zoomSpeed;
          camera.position.multiplyScalar(newZoom / camera.position.length());
        }
      });

      canvas.addEventListener('touchend', () => {
        touchStartDistance = 0;
      });

      // I≈üƒ±klar
      scene.add(new THREE.AmbientLight(0x404040, 0.8));
      const dirLight = new THREE.DirectionalLight(0xffffff, 1.2);
      dirLight.position.set(5, 10, 7);
      scene.add(dirLight);

      let model, pieces = [], originalData = [];
      let isExploded = false;
      let autoTour = false;

      // === MODEL Y√úKLE ===
      const loader = new THREE.GLTFLoader();
      loader.load(
        './lieutenantHead.gltf',
        (gltf) => {
          model = gltf.scene;
          scene.add(model);

          const box = new THREE.Box3().setFromObject(model);
          const center = box.getCenter(new THREE.Vector3());
          const size = box.getSize(new THREE.Vector3());
          model.position.sub(center);
          const maxDim = Math.max(size.x, size.y, size.z);
          model.scale.setScalar(5 / maxDim);

          loadingEl.style.display = 'none';

          // Par√ßalara ayƒ±r
          model.traverse((child) => {
            if (child.isMesh) {
              pieces.push(child);
              originalData.push({
                position: child.position.clone(),
                rotation: child.rotation.clone(),
                emissive: child.material.emissive.clone(),
                emissiveIntensity: child.material.emissiveIntensity
              });

              child.userData.originalEmissive = child.material.emissive.clone();
              child.userData.originalIntensity = child.material.emissiveIntensity;
            }
          });

          console.log(`${pieces.length} par√ßa hazƒ±r.`);
          statusEl.textContent = `${pieces.length} par√ßa hazƒ±r`;
        },
        undefined,
        (err) => {
          console.error('Hata:', err);
          loadingEl.textContent = 'Model y√ºklenemedi!';
          loadingEl.style.color = '#f00';
        }
      );

      // === PAR√áALAMA ===
      function explode() {
        if (isExploded || pieces.length === 0) return;
        isExploded = true;
        explodeBtn.disabled = true;
        statusEl.textContent = "Par√ßalar ayrƒ±lƒ±yor...";

        pieces.forEach((piece, i) => {
          const delay = i * 0.05;
          const dist = 0.8 + Math.random() * 0.7;
          const angle = (i / pieces.length) * Math.PI * 2 + Math.random() * 0.5;
          const height = (Math.random() - 0.5) * 0.8;

          const target = {
            x: Math.cos(angle) * dist,
            y: originalData[i].position.y + height,
            z: Math.sin(angle) * dist
          };

          gsap.to(piece.position, {
            ...target,
            duration: 2.5,
            delay,
            ease: "slow(0.7, 0.7, false)"
          });

          gsap.to(piece.rotation, {
            x: originalData[i].rotation.x + (Math.random() - 0.5) * 0.8,
            y: originalData[i].rotation.y + (Math.random() - 0.5) * 1.2,
            z: originalData[i].rotation.z + (Math.random() - 0.5) * 0.8,
            duration: 2.5,
            delay,
            ease: "slow(0.7, 0.7, false)"
          });

          gsap.to(piece.material, {
            emissiveIntensity: 2.5,
            duration: 0.6,
            yoyo: true,
            repeat: 1,
            delay: delay + 1
          });
        });

        setTimeout(() => {
          explodeBtn.disabled = false;
          statusEl.textContent = "Par√ßalar ayrƒ±ldƒ±";
        }, 3000);
      }

      // === TOPLAMA ===
      function collect() {
        if (!isExploded || pieces.length === 0) return;
        isExploded = false;
        collectBtn.disabled = true;
        statusEl.textContent = "Par√ßalar toplanƒ±yor...";

        pieces.forEach((piece, i) => {
          const delay = i * 0.03;

          gsap.to(piece.position, {
            x: originalData[i].position.x,
            y: originalData[i].position.y,
            z: originalData[i].position.z,
            duration: 2,
            delay,
            ease: "back.inOut(1.7)"
          });

          gsap.to(piece.rotation, {
            x: originalData[i].rotation.x,
            y: originalData[i].rotation.y,
            z: originalData[i].rotation.z,
            duration: 2,
            delay,
            ease: "power2.inOut"
          });

          gsap.to(piece.material, {
            emissiveIntensity: originalData[i].emissiveIntensity,
            duration: 1,
            delay
          });
        });

        setTimeout(() => {
          collectBtn.disabled = false;
          statusEl.textContent = "Par√ßalar toplandƒ±";
        }, 2500);
      }

      // === OTOMATƒ∞K TUR ===
      autoBtn.onclick = () => {
        autoTour = !autoTour;
        autoBtn.textContent = autoTour ? "DURDUR" : "OTOMATƒ∞K TUR";
        autoBtn.style.background = autoTour ? "#0f0" : "#0a3d62";
        autoBtn.style.color = autoTour ? "#000" : "#0ff";
      };

      // === FARE VURGU (Desktop) ===
      const raycaster = new THREE.Raycaster();
      const mouse = new THREE.Vector2();
      let hoveredPiece = null;

      canvas.addEventListener('mousemove', (e) => {
        mouse.x = (e.clientX / innerWidth) * 2 - 1;
        mouse.y = -(e.clientY / innerHeight) * 2 + 1;

        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(pieces, true);

        if (intersects.length > 0) {
          const piece = intersects[0].object;
          if (hoveredPiece !== piece) {
            if (hoveredPiece) {
              hoveredPiece.material.emissive.copy(hoveredPiece.userData.originalEmissive);
              hoveredPiece.material.emissiveIntensity = hoveredPiece.userData.originalIntensity;
            }
            piece.material.emissive.set(0x00ffff);
            piece.material.emissiveIntensity = 3;
            hoveredPiece = piece;
          }
        } else if (hoveredPiece) {
          hoveredPiece.material.emissive.copy(hoveredPiece.userData.originalEmissive);
          hoveredPiece.material.emissiveIntensity = hoveredPiece.userData.originalIntensity;
          hoveredPiece = null;
        }
      });

      // === BUTONLAR ===
      explodeBtn.onclick = explode;
      collectBtn.onclick = collect;

      // === RESIZE ===
      window.addEventListener('resize', () => {
        camera.aspect = innerWidth / innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(innerWidth, innerHeight);
      });

      // === TAM EKRAN ===
      document.addEventListener('keydown', (e) => {
        if (e.key === 'f' || e.key === 'F') {
          if (!document.fullscreenElement) document.body.requestFullscreen();
          else document.exitFullscreen();
        }
      });

      // === ANA D√ñNG√ú ===
      const clock = new THREE.Clock();
      function animate() {
        const rotationSpeed = parseFloat(rotationSpeedSlider.value);
        
        if (autoTour && !isExploded) {
          controls.autoRotate = true;
          controls.autoRotateSpeed = 0.5 * rotationSpeed;
        } else {
          controls.autoRotate = false;
        }

        controls.update();
        renderer.render(scene, camera);
        requestAnimationFrame(animate);
      }
      animate();
    });
  </script>
</body>
</html>