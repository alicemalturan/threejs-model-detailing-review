<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LieutenantHead - Makine İncelemesi</title>

  <!-- Three.js -->
  <script src="https://unpkg.com/three@0.139.2/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.139.2/examples/js/controls/OrbitControls.js"></script>
  <script src="https://unpkg.com/three@0.139.2/examples/js/loaders/GLTFLoader.js"></script>

  <!-- GSAP -->
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>

  <style>
    body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
    canvas { display: block; }
    .info {
      position: absolute; top: 15px; left: 15px; color: #0ff; font-family: 'Courier New', monospace;
      background: rgba(0,0,0,0.7); padding: 10px 15px; border-radius: 8px; font-size: 14px;
      border: 1px solid #0ff; text-shadow: 0 0 8px #0ff; z-index: 100; pointer-events: none;
    }
    .controls {
      position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.7); padding: 15px 30px; border-radius: 50px;
      color: #0ff; font-family: monospace; font-size: 16px; border: 1px solid #0ff;
      box-shadow: 0 0 20px rgba(0,255,255,0.4); z-index: 100; text-align: center;
      display: flex; gap: 12px; align-items: center; justify-content: center;
    }
    .controls button {
      background: #0a3d62; color: #0ff; border: 1px solid #0ff; padding: 12px 20px;
      border-radius: 25px; cursor: pointer; font-weight: bold; font-size: 14px;
      transition: all 0.3s; box-shadow: 0 0 10px rgba(0,255,255,0.3);
    }
    .controls button:hover { background: #0ff; color: #000; transform: translateY(-2px); }
    .controls button:active { transform: translateY(0); }
    .loading {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      color: #0ff; font-size: 20px; text-shadow: 0 0 15px #0ff;
    }
  </style>
</head>
<body>

  <div class="info">
    Fare: Döndür • Tekerlek: Yakınlaş • F: Tam Ekran<br>
    <span id="status">Hazır</span>
  </div>

  <div class="controls">
    <button id="explodeBtn">PARÇALA</button>
    <button id="collectBtn">TOPLA</button>
    <button id="autoBtn">OTOMATİK TUR</button>
  </div>

  <div class="loading" id="loading">Model Yükleniyor...</div>

  <canvas id="canvas"></canvas>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const canvas = document.getElementById('canvas');
      const loadingEl = document.getElementById('loading');
      const statusEl = document.getElementById('status');
      const explodeBtn = document.getElementById('explodeBtn');
      const collectBtn = document.getElementById('collectBtn');
      const autoBtn = document.getElementById('autoBtn');

      // Sahne
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x000814);

      // Kamera
      const camera = new THREE.PerspectiveCamera(60, innerWidth / innerHeight, 0.1, 1000);
      camera.position.set(0, 0, 10);

      // Renderer
      const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
      renderer.setSize(innerWidth, innerHeight);
      renderer.setPixelRatio(Math.min(devicePixelRatio, 2));

      // Kontroller
      const controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.target.set(0, 0, 0);

      // Işıklar
      scene.add(new THREE.AmbientLight(0x404040, 0.8));
      const dirLight = new THREE.DirectionalLight(0xffffff, 1.2);
      dirLight.position.set(5, 10, 7);
      scene.add(dirLight);

      let model, pieces = [], originalData = [];
      let isExploded = false;
      let autoTour = false;

      // === MODEL YÜKLE ===
      const loader = new THREE.GLTFLoader();
      loader.load(
        './lieutenantHead.gltf',
        (gltf) => {
          model = gltf.scene;
          scene.add(model);

          const box = new THREE.Box3().setFromObject(model);
          const center = box.getCenter(new THREE.Vector3());
          const size = box.getSize(new THREE.Vector3());
          model.position.sub(center);
          const maxDim = Math.max(size.x, size.y, size.z);
          model.scale.setScalar(5 / maxDim);

          loadingEl.style.display = 'none';

          // Parçalara ayır
          model.traverse((child) => {
            if (child.isMesh) {
              pieces.push(child);
              originalData.push({
                position: child.position.clone(),
                rotation: child.rotation.clone(),
                emissive: child.material.emissive.clone(),
                emissiveIntensity: child.material.emissiveIntensity
              });

              // Fare ile vurgu
              child.userData.originalEmissive = child.material.emissive.clone();
              child.userData.originalIntensity = child.material.emissiveIntensity;
            }
          });

          console.log(`${pieces.length} parça hazır.`);
          statusEl.textContent = `${pieces.length} parça hazır`;
        },
        undefined,
        (err) => {
          console.error('Hata:', err);
          loadingEl.textContent = 'Model yüklenemedi!';
          loadingEl.style.color = '#f00';
        }
      );

      // === YAKIN MESAFE PARÇALANMA ===
      function explode() {
        if (isExploded || pieces.length === 0) return;
        isExploded = true;
        explodeBtn.disabled = true;
        statusEl.textContent = "Parçalar ayrılıyor...";

        pieces.forEach((piece, i) => {
          const delay = i * 0.05;
          const dist = 0.8 + Math.random() * 0.7; // 0.8 - 1.5 birim
          const angle = (i / pieces.length) * Math.PI * 2 + Math.random() * 0.5;
          const height = (Math.random() - 0.5) * 0.8;

          const target = {
            x: Math.cos(angle) * dist,
            y: originalData[i].position.y + height,
            z: Math.sin(angle) * dist
          };

          gsap.to(piece.position, {
            ...target,
            duration: 2.5,
            delay,
            ease: "slow(0.7, 0.7, false)"
          });

          gsap.to(piece.rotation, {
            x: originalData[i].rotation.x + (Math.random() - 0.5) * 0.8,
            y: originalData[i].rotation.y + (Math.random() - 0.5) * 1.2,
            z: originalData[i].rotation.z + (Math.random() - 0.5) * 0.8,
            duration: 2.5,
            delay,
            ease: "slow(0.7, 0.7, false)"
          });

          gsap.to(piece.material, {
            emissiveIntensity: 2.5,
            duration: 0.6,
            yoyo: true,
            repeat: 1,
            delay: delay + 1
          });
        });

        setTimeout(() => {
          explodeBtn.disabled = false;
          statusEl.textContent = "Parçalar ayrıldı";
        }, 3000);
      }

      // === TOPLAMA ===
      function collect() {
        if (!isExploded || pieces.length === 0) return;
        isExploded = false;
        collectBtn.disabled = true;
        statusEl.textContent = "Parçalar toplanıyor...";

        pieces.forEach((piece, i) => {
          const delay = i * 0.03;

          gsap.to(piece.position, {
            x: originalData[i].position.x,
            y: originalData[i].position.y,
            z: originalData[i].position.z,
            duration: 2,
            delay,
            ease: "back.inOut(1.7)"
          });

          gsap.to(piece.rotation, {
            x: originalData[i].rotation.x,
            y: originalData[i].rotation.y,
            z: originalData[i].rotation.z,
            duration: 2,
            delay,
            ease: "power2.inOut"
          });

          gsap.to(piece.material, {
            emissiveIntensity: originalData[i].emissiveIntensity,
            duration: 1,
            delay
          });
        });

        setTimeout(() => {
          collectBtn.disabled = false;
          statusEl.textContent = "Parçalar toplandı";
        }, 2500);
      }

      // === OTOMATİK TUR ===
      autoBtn.onclick = () => {
        autoTour = !autoTour;
        autoBtn.textContent = autoTour ? "DURDUR" : "OTOMATİK TUR";
        autoBtn.style.background = autoTour ? "#0f0" : "#0a3d62";
        autoBtn.style.color = autoTour ? "#000" : "#0ff";
      };

      // === FARE VURGU ===
      const raycaster = new THREE.Raycaster();
      const mouse = new THREE.Vector2();
      let hoveredPiece = null;

      canvas.addEventListener('mousemove', (e) => {
        mouse.x = (e.clientX / innerWidth) * 2 - 1;
        mouse.y = -(e.clientY / innerHeight) * 2 + 1;

        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(pieces, true);

        if (intersects.length > 0) {
          const piece = intersects[0].object;
          if (hoveredPiece !== piece) {
            if (hoveredPiece) {
              hoveredPiece.material.emissive.copy(hoveredPiece.userData.originalEmissive);
              hoveredPiece.material.emissiveIntensity = hoveredPiece.userData.originalIntensity;
            }
            piece.material.emissive.set(0x00ffff);
            piece.material.emissiveIntensity = 3;
            hoveredPiece = piece;
          }
        } else if (hoveredPiece) {
          hoveredPiece.material.emissive.copy(hoveredPiece.userData.originalEmissive);
          hoveredPiece.material.emissiveIntensity = hoveredPiece.userData.originalIntensity;
          hoveredPiece = null;
        }
      });

      // === BUTONLAR ===
      explodeBtn.onclick = explode;
      collectBtn.onclick = collect;

      // === RESIZE ===
      window.addEventListener('resize', () => {
        camera.aspect = innerWidth / innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(innerWidth, innerHeight);
      });

      // === TAM EKRAN ===
      document.addEventListener('keydown', (e) => {
        if (e.key === 'f' || e.key === 'F') {
          if (!document.fullscreenElement) document.body.requestFullscreen();
          else document.exitFullscreen();
        }
      });

      // === ANA DÖNGÜ ===
      const clock = new THREE.Clock();
      function animate() {
        const delta = clock.getDelta();

        if (autoTour && !isExploded) {
          controls.autoRotate = true;
          controls.autoRotateSpeed = 0.5;
        } else {
          controls.autoRotate = false;
        }

        controls.update();
        renderer.render(scene, camera);
        requestAnimationFrame(animate);
      }
      animate();
    });
  </script>
</body>
</html>